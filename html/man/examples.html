
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real examples &#8212; TrueSkillThroughTime 0.0.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="The History class" href="history.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="real-examples">
<span id="sec-real-examples"></span><h1>Real examples<a class="headerlink" href="#real-examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-history-of-the-association-of-tennis-professionals">
<h2>The History of the Association of Tennis Professionals<a class="headerlink" href="#the-history-of-the-association-of-tennis-professionals" title="Permalink to this headline">¶</a></h2>
<p>In this last example, we analyze the complete history of the Association of Tennis Professionals (ATP) registered matches.
The database has 447000 games starting in 1915 until 2020 with more than 19000 participating players and is publicly available.
The information stored in a [single CSV file](<a class="reference external" href="https://github.com/glandfried/tennis_atp/releases/download/atp/history.csv.zip">https://github.com/glandfried/tennis_atp/releases/download/atp/history.csv.zip</a>).
Each game has an identifier (i.e. <code class="code docutils literal notranslate"><span class="pre">match_id</span></code>) and its tournament’s round number (i.e. <code class="code docutils literal notranslate"><span class="pre">round_number</span></code>), where 0 represents the final game, 1 the semi-final, and so on.
The file also contains players’ identifiers and names.
For example, column <code class="code docutils literal notranslate"><span class="pre">w2_id</span></code> is the second player’s identifier of the winning team, and <code class="code docutils literal notranslate"><span class="pre">l1_name</span></code> is the first player’s name of the losing team.
Finally, we have the tournament’s name (<code class="code docutils literal notranslate"><span class="pre">tour_name</span></code>), its identifier (<code class="code docutils literal notranslate"><span class="pre">tour_id</span></code>), the tournament’s starting date (<code class="code docutils literal notranslate"><span class="pre">time_start</span></code>), and the type of surface (<code class="code docutils literal notranslate"><span class="pre">ground</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;input/history.csv&#39;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">columns</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">w1_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">w2_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">l1_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">l2_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="n">composition</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">],[</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">]]</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="k">else</span> <span class="p">[[</span><span class="n">w1</span><span class="p">],[</span><span class="n">l1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">columns</span> <span class="p">]</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">time_start</span><span class="p">]</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span><span class="n">composition</span> <span class="o">=</span> <span class="n">composition</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.6</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.036</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">convergence</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>In this code, we open the file <code class="code docutils literal notranslate"><span class="pre">history.csv</span></code>, create the variables <code class="code docutils literal notranslate"><span class="pre">times</span></code> and <code class="code docutils literal notranslate"><span class="pre">composition</span></code>, and instantiate the class <code class="code docutils literal notranslate"><span class="pre">History</span></code>.
We define the event times as the days elapsed from a reference date to the tournament start date, assuming that the skill is the same within each tournament.
When generating the list <code class="code docutils literal notranslate"><span class="pre">composition</span></code> we discriminate whether the games are doubles or singles using the column <code class="code docutils literal notranslate"><span class="pre">double</span></code>.
The results are determined by the composition’s order, placing the winning team first.
When initializing the class <code class="code docutils literal notranslate"><span class="pre">History</span></code> we set the values of <code class="code docutils literal notranslate"><span class="pre">sigma</span></code> and <code class="code docutils literal notranslate"><span class="pre">gamma</span></code> based on an optimization procedure previously performed.
Finally, we use the <code class="code docutils literal notranslate"><span class="pre">convergence()</span></code> method to obtain TrueSkill Through Time estimates explicitly selecting the convergence criterion: when the change between iterations is less than 0.01 or when ten iterations are performed.</p>
<p>The following figure presents the estimated learning curves of some famous players in ATP’s history, which we identified using different colors
The learning curves share a similar pattern: they begin with rapid growth, reach an unstable plateau, and end with a slow decline (we hidden the last portion of the players who have long final stages for visualization purposes).</p>
<img alt="../_images/atp.png" src="../_images/atp.png" />
<p>The top bar indicates which player was at the top of the ATP’s ranking (the bar has no color when player number 1 is not included among the 10 players identified with colors).
ATP’s ranking points are updated every Monday according to the prestige of the tournament and the stage reached.
There is a relative coincidence between the skill estimates and who is at any given moment at the top of the ATP rankings.
The following Table shows the historical ranking of players in the top position of the ATP’s ranking according to the number of weeks occupying the first position.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 53%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>No</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Weeks at top</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Novak Djokovic</p></td>
<td><p>320</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Roger Federer</p></td>
<td><p>310</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Pete Sampras</p></td>
<td><p>286</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>Ivan Lendl</p></td>
<td><p>270</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>Jimmy Connors</p></td>
<td><p>268</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>Rafael Nadal</p></td>
<td><p>209</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>John McEnroe</p></td>
<td><p>170</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>Bjorn Borg</p></td>
<td><p>109</p></td>
</tr>
<tr class="row-even"><td><p>9</p></td>
<td><p>Andre Agassi</p></td>
<td><p>101</p></td>
</tr>
<tr class="row-odd"><td><p>10</p></td>
<td><p>Lleyton Hewitt</p></td>
<td><p>80</p></td>
</tr>
<tr class="row-even"><td><p>11</p></td>
<td><p>Stefan Edberg</p></td>
<td><p>72</p></td>
</tr>
<tr class="row-odd"><td><p>12</p></td>
<td><p>Jim Courier</p></td>
<td><p>58</p></td>
</tr>
<tr class="row-even"><td><p>13</p></td>
<td><p>Gustavo Kuerten</p></td>
<td><p>43</p></td>
</tr>
<tr class="row-odd"><td><p>14</p></td>
<td><p>Andy Murray</p></td>
<td><p>41</p></td>
</tr>
<tr class="row-even"><td><p>15</p></td>
<td><p>Ilie Nastase</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-odd"><td><p>16</p></td>
<td><p>Mats Wilander</p></td>
<td><p>20</p></td>
</tr>
</tbody>
</table>
<p>However, TrueSkill Through Time allows comparing the relative ability of players over time: the 10th player in the historical ATP’s ranking, Hewitt, is a product of the window of opportunity that was opened in the year 2000; and the 4th most skilled player, Murray, is ranked 14th just above Nastase.
Individual learning curves enable recognizing special periods of crisis and prolonged stability of the professional players, and even the effects of emotional slumps such as those suffered by Aggasi and Djokovic.
It is worthwhile to note that the skill of tennis players did not increase abruptly over the years: contrary to what might have been expected, the players of the 1980s were more skilled than those of the 1990s, and reached a skill similar to what Federer, Nadal and Djokovic had in 2020, even though the latter reached higher values for a longer time.</p>
</div>
<div class="section" id="multidimensional-skills">
<h2>Multidimensional skills<a class="headerlink" href="#multidimensional-skills" title="Permalink to this headline">¶</a></h2>
<p>In the previous example, we summarize the players’ skills in a single dimension.
TrueSkill Through Time allows estimating multi-dimensional skills.
It is known that the ability of certain tennis players varies significantly depending on the surface.
To quantify this phenomenon, we propose modeling each player as a team composed of a generic player, who is included in all the games, and another player representing the ability of the player on a particular surface.
For example, Nadal will be represented as a two-player team: <code class="code docutils literal notranslate"><span class="pre">Nadal_generic</span></code> and <code class="code docutils literal notranslate"><span class="pre">Nadal_clay</span></code> when playing on this kind of surface, and <code class="code docutils literal notranslate"><span class="pre">Nadal_generic</span></code> and <code class="code docutils literal notranslate"><span class="pre">Nadal_grass</span></code> when participating in the Wimbledon tournament.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">trueskillthroughtime</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;input/history.csv&#39;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">columns</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">w1_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">w2_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">l1_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">l2_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">ground</span><span class="p">)</span>
<span class="n">composition</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">w1</span><span class="p">,</span><span class="n">w1</span><span class="o">+</span><span class="n">g</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">w2</span><span class="o">+</span><span class="n">g</span><span class="p">],[</span><span class="n">l1</span><span class="p">,</span><span class="n">l1</span><span class="o">+</span><span class="n">g</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l2</span><span class="o">+</span><span class="n">g</span><span class="p">]]</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="k">else</span> <span class="p">[[</span><span class="n">w1</span><span class="p">,</span><span class="n">w1</span><span class="o">+</span><span class="n">g</span><span class="p">],[</span><span class="n">l1</span><span class="p">,</span><span class="n">l1</span><span class="o">+</span><span class="n">g</span><span class="p">]]</span> <span class="k">for</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">columns</span> <span class="p">]</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">time_start</span><span class="p">]</span>

<span class="n">columns</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">w1_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">w2_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">l1_id</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">l2_id</span><span class="p">)</span>
<span class="n">player_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span> <span class="n">player</span> <span class="k">for</span> <span class="n">game</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="n">game</span> <span class="p">])</span>

<span class="n">priors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">p</span><span class="p">,</span> <span class="n">Player</span><span class="p">(</span><span class="n">Gaussian</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.036</span><span class="p">)</span> <span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">player_ids</span><span class="p">])</span>

<span class="n">h_ground</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span><span class="n">composition</span> <span class="o">=</span> <span class="n">composition</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">priors</span> <span class="o">=</span> <span class="n">priors</span><span class="p">)</span>
<span class="n">h_ground</span><span class="o">.</span><span class="n">convergence</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, we keep the same prior as before for all the generic players, but in this code we define them using the variable <code class="code docutils literal notranslate"><span class="pre">priors</span></code>.
We create the teams depending on whether the game is double or single, adding the specific surface skills of each player as their teammate (we use the operator <code class="code docutils literal notranslate"><span class="pre">+</span></code> to concatenate strings).
As the specific surface skills are not defined in the variable <code class="code docutils literal notranslate"><span class="pre">prior</span></code>, they are initialized using the default values defined in the class <code class="code docutils literal notranslate"><span class="pre">History</span></code>.
We also define <code class="code docutils literal notranslate"><span class="pre">beta</span></code> as null for specific surface skills to avoid adding additional noise to the players’ performance, keeping the scale of the estimates stable.
We select a <code class="code docutils literal notranslate"><span class="pre">sigma</span></code> that we consider sufficiently large and a dynamic factor <code class="code docutils literal notranslate"><span class="pre">gamma</span></code> representing 1% of the prior uncertainty.</p>
<p>In the following Figures, we show the skill difference that Nadal and Djokovic have in each of the three types of ground.</p>
<img alt="../_images/atp_ground0.png" src="../_images/atp_ground0.png" />
<p>Nadal has a notorious skill difference when playing on different surfaces.
The Nadal’s skill difference between clay and grass grounds is greater than one <span class="math notranslate nohighlight">\(\beta\)</span>, which means at least 76% difference in probability of winning compared to itself.
On the contrary, Djokovic has very similar skills in the three types.</p>
<img alt="../_images/atp_ground2.png" src="../_images/atp_ground2.png" />
<p>In the case of Nadal (id <code class="code docutils literal notranslate"><span class="pre">&quot;n409&quot;</span></code>), it seems important to model the skill’s multi-dimensionality, while in Djokovic’s case (id <code class="code docutils literal notranslate"><span class="pre">&quot;d643&quot;</span></code>) it seems reasonable to summarize it in a single dimension.
To assess whether the complexity added by modeling multi-dimensionality is appropriate in general terms, we can compare the joint prior prediction of the models, calling the method <code class="code docutils literal notranslate"><span class="pre">log_evidence()</span></code> of the class <code class="code docutils literal notranslate"><span class="pre">History</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">h_ground</span><span class="o">.</span><span class="n">log_evidence</span><span class="p">()</span>
</pre></div>
</div>
<p>In tennis, it is sufficient to summarize the skills in a single dimension since the <code class="code docutils literal notranslate"><span class="pre">log_evidence</span></code> is maximized when the parameters of the surface’s factors (i.e. <span class="math notranslate nohighlight">\(\sigma\)</span> and <code class="code docutils literal notranslate"><span class="pre">\gamma</span></code>) vanish.
In other examples, where the multi-dimensionality of skills could be more relevant, it should be necessary to model the skills of all agents using different components.</p>
<p>If we consider only the games in which Nadal participates, optimality is achieved when the parameters take the values <span class="math notranslate nohighlight">\(\sigma=0.35\)</span> and <span class="math notranslate nohighlight">\(\gamma=0\)</span>, meaning that it is necessary to model multidimensional skills (<span class="math notranslate nohighlight">\(\sigma&gt;0\)</span>) but considering that their effect does not change over time (<span class="math notranslate nohighlight">\(\gamma = 0\)</span>).
In this scenario, Nadal’s ability on Clay is <span class="math notranslate nohighlight">\(0.87\beta\)</span> higher than on Hard and <span class="math notranslate nohighlight">\(1.05\beta\)</span> higher than on Grass.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">TrueSkillThroughTime</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="causal.html">Causal model</a></li>
<li class="toctree-l1"><a class="reference internal" href="gaussian.html">The <cite>Gaussian</cite> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="player.html">The <cite>Player</cite> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="game.html">The <cite>Game</cite> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">The <cite>History</cite> class</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Real examples</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="history.html" title="previous chapter">The <cite>History</cite> class</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Gustavo Landfried.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="../_sources/man/examples.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>